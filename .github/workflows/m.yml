name: Pull and Save Docker Image

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: 'mekayelanik/samba-server-alpine'
  ARCH: 'arm64'

jobs:
  pull-save-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU for multi-arch
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub (optional)
      if: ${{ secrets.DOCKERHUB_USERNAME }}
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Pull Docker image
      run: |
        # 设置完整的镜像标签
        IMAGE_TAG="$IMAGE_NAME:${{ github.event.inputs.image_tag || 'latest' }}"
        echo "Pulling image: $IMAGE_TAG (architecture: $ARCH)"
        
        # 拉取指定架构的镜像
        docker pull --platform linux/$ARCH $IMAGE_TAG
        
        # 验证镜像
        docker image inspect $IMAGE_TAG | jq -r '.[0].Architecture'

    - name: Save image as tar file
      run: |
        IMAGE_TAG="$IMAGE_NAME:${{ github.event.inputs.image_tag || 'latest' }}"
        TAR_NAME="samba-server-alpine-$ARCH-${{ github.event.inputs.image_tag || 'latest' }}-$(date +%Y%m%d).tar"
        
        # 保存镜像为tar文件
        docker save -o $TAR_NAME $IMAGE_TAG
        
        # 压缩tar文件（可选）
        gzip $TAR_NAME
        
        echo "TAR_FILE=$TAR_NAME.gz" >> $GITHUB_ENV
        echo "IMAGE_SIZE=$(ls -lh $TAR_NAME.gz | awk '{print $5}')" >> $GITHUB_ENV

    - name: Upload tar file as artifact
      uses: actions/upload-artifact@v4
      with:
        name: samba-server-image
        path: ${{ env.TAR_FILE }}
        retention-days: 7

    - name: Create checksum
      run: |
        sha256sum ${{ env.TAR_FILE }} > ${{ env.TAR_FILE }}.sha256
        echo "Checksum created"

    - name: Upload checksum
      uses: actions/upload-artifact@v4
      with:
        name: image-checksum
        path: ${{ env.TAR_FILE }}.sha256
        retention-days: 7

    - name: Summary
      run: |
        echo "### Docker Image Saved Successfully ✅" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** $IMAGE_NAME:${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** $ARCH" >> $GITHUB_STEP_SUMMARY
        echo "- **File size:** ${{ env.IMAGE_SIZE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Download:** Available as artifact" >> $GITHUB_STEP_SUMMARY
